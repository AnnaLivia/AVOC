# ===== Paths =====
matlab_path := /Applications/MATLAB_R2022b.app
gurobi_path := /Library/gurobi1202/macos_universal2
arma_prefix := /usr/local/Cellar/armadillo/15.0.2
blas_prefix := /usr/local/opt/openblas

# ===== Sources / Objects =====
sources := main.cpp ac_heuristic.cpp mount_model.cpp sdp_solver_util.cpp sdp_branch_and_bound.cpp \
           matlab_util.cpp kmeans_util.cpp Kmeans.cpp JobQueue.cpp util.cpp ilp_model.cpp \
           feasibility.cpp ub_heuristics.cpp ThreadPool.cpp ThreadPoolPartition.cpp
objects := $(sources:.cpp=.o)

# ===== Toolchain (Apple clang) =====
CXX      := /usr/bin/clang++
CXXFLAGS := -O2 -pthread -std=c++17 -arch x86_64 \
            -I$(arma_prefix)/include \
            -I$(blas_prefix)/include \
            -I$(matlab_path)/extern/include \
            -I$(gurobi_path)/include

# ===== Linker flags =====
# Order matters: your objects, then libs
LDFLAGS  := \
  -L$(arma_prefix)/lib \
  -L$(blas_prefix)/lib \
  -L$(matlab_path)/extern/bin/maci64 \
  -L$(gurobi_path)/lib \
  -lMatlabEngine -lMatlabDataArray \
  -larmadillo -llapack -lopenblas \
  -lgurobi_c++ -lgurobi120 \
  -Wl,-rpath,$(arma_prefix)/lib \
  -Wl,-rpath,$(blas_prefix)/lib \
  -Wl,-rpath,$(matlab_path)/extern/bin/maci64 \
  -Wl,-rpath,$(gurobi_path)/lib

# ===== Targets =====
all: avoc

avoc: $(objects)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

.PHONY: clean
clean:
	rm -f avoc $(objects)
